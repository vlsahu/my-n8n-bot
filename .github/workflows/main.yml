name: "Production v82 (Core Debugger)"

on:
  workflow_dispatch:

jobs:
  debug-core:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. SETUP ENVIRONMENT
      - name: üõ†Ô∏è Setup Node.js & Tools
        run: |
          sudo apt-get update && sudo apt-get install -y curl
          # Install Ngrok
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt-get update && sudo apt-get install -y ngrok
          echo "‚úÖ Environment Ready"

      # 2. CREATE PURE DEBUG BOT
      - name: üìù Write Debug Code
        run: |
          mkdir bot
          cd bot
          npm init -y
          npm install @whiskeysockets/baileys@^6.7.0 mongoose qrcode express pino

          # --- SIMPLEST INDEX.JS ---
          cat << 'EOF' > index.js
          const { default: makeWASocket, useMultiFileAuthState, DisconnectReason, makeCacheableSignalKeyStore } = require('@whiskeysockets/baileys');
          const mongoose = require('mongoose');
          const express = require('express');
          const QRCode = require('qrcode');
          const pino = require('pino');
          
          const app = express();
          const MONGO_URL = process.env.MONGODB_URI;
          let qrData = null;

          // 1. DATABASE MODEL
          const authSchema = new mongoose.Schema({ _id: String, data: Object });
          const AuthModel = mongoose.model('Auth_Debug', authSchema);

          // 2. MONGO CONNECTION TESTER
          async function connectDB() {
              console.log("üü° [STEP 1] Connecting to MongoDB...");
              console.log(`‚ÑπÔ∏è URI Length: ${MONGO_URL ? MONGO_URL.length : 'MISSING'}`);
              
              try {
                  // Force database name 'wa_debug_db'
                  await mongoose.connect(MONGO_URL, { dbName: 'wa_debug_db' });
                  console.log("‚úÖ [STEP 1] MongoDB Connected Successfully!");
                  
                  // TEST WRITE
                  console.log("üü° [STEP 2] Testing Database Write...");
                  await AuthModel.findOneAndUpdate({ _id: 'test_doc' }, { data: { status: 'working' } }, { upsert: true });
                  console.log("‚úÖ [STEP 2] Write Successful! DB is 100% OK.");
              } catch (err) {
                  console.error("\n‚ùå‚ùå‚ùå FATAL DATABASE ERROR ‚ùå‚ùå‚ùå");
                  console.error(err);
                  console.error("‚ùå Fix your MONGODB_URI Secret in GitHub Settings!");
                  process.exit(1);
              }
          }

          // 3. WHATSAPP LOGIC
          async function startBot() {
              await connectDB();

              console.log("üü° [STEP 3] Starting Baileys...");
              
              // Custom Mongo Auth Adapter
              const { state, saveCreds } = await useMongoDBAuthState(AuthModel);

              const sock = makeWASocket({
                  auth: { creds: state.creds, keys: makeCacheableSignalKeyStore(state.keys, pino({ level: "silent" })) },
                  printQRInTerminal: true, // Show QR in Logs too
                  logger: pino({ level: "info" }), // Enable Info Logs
                  browser: ["Debug Bot", "Chrome", "1.0.0"]
              });

              sock.ev.on('creds.update', saveCreds);
              sock.ev.on('connection.update', (update) => {
                  const { connection, lastDisconnect, qr } = update;
                  if(qr) { 
                      qrData = qr; 
                      console.log("‚úÖ [STEP 4] QR Generated! Scan via Link."); 
                  }
                  if(connection === 'close') {
                      const shouldReconnect = lastDisconnect.error?.output?.statusCode !== DisconnectReason.loggedOut;
                      console.log('‚ùå Connection closed due to ', lastDisconnect.error, ', reconnecting ', shouldReconnect);
                      if(shouldReconnect) startBot();
                  }
                  if(connection === 'open') {
                      console.log('‚úÖ [SUCCESS] WhatsApp Connected!');
                  }
              });
          }

          // Helper for Auth
          async function useMongoDBAuthState(collection) {
              const writeData = (data, id) => collection.findOneAndUpdate({ _id: id }, { data: data, _id: id }, { upsert: true }).catch(err => console.error("Write Fail:", err));
              const readData = async (id) => { try { const d = await collection.findById(id); return d ? d.data : null; } catch { return null; } };
              const removeData = async (id) => { try { await collection.findByIdAndDelete(id); } catch {} };
              const creds = (await readData('creds')) || (await (require('@whiskeysockets/baileys').initAuthCreds)());
              return {
                  state: {
                      creds,
                      keys: {
                          get: async (type, ids) => { const data = {}; await Promise.all(ids.map(async id => { let val = await readData(`${type}-${id}`); if(val) data[id] = val; })); return data; },
                          set: async (data) => { const tasks = []; for(const cat in data) for(const id in data[cat]) { const val = data[cat][id]; const key = `${cat}-${id}`; tasks.push(val ? writeData(val, key) : removeData(key)); } await Promise.all(tasks); }
                      }
                  },
                  saveCreds: () => writeData(creds, 'creds')
              };
          }

          // 4. SERVER FOR QR
          app.get('/qr', async (req, res) => {
              if (!qrData) return res.send('<h1>Check GitHub Logs... Starting...</h1><meta http-equiv="refresh" content="2">');
              const url = await QRCode.toDataURL(qrData);
              res.send(`<center><h1>Scan Me</h1><img src="${url}" /></center>`);
          });
          
          app.listen(10000, () => {
              console.log("üöÄ Server running on Port 10000");
              startBot();
          });
          EOF

      # 3. RUN & EXPOSE
      - name: üöÄ Run Debugger
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          NGROK_AUTH: ${{ secrets.NGROK_TOKEN }}
        run: |
          cd bot
          
          # Start Ngrok in Background
          ngrok config add-authtoken $NGROK_AUTH
          ngrok http --domain=${{ secrets.NGROK_DOMAIN }} 10000 > /dev/null &
          sleep 5
          
          echo "üîó OPEN THIS LINK: https://${{ secrets.NGROK_DOMAIN }}/qr"
          
          # Run Node directly (No Docker) to see logs instantly
          node index.js
